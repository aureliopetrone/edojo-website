# 📚 Documentazione API Blog eDojo

Le API del blog permettono di pubblicare, aggiornare ed eliminare articoli automaticamente sul sito eDojo.

## 🔧 Setup Iniziale

### 1. Configura il Token Sanity

Aggiungi al tuo file `.env`:

```bash
SANITY_API_TOKEN="your_sanity_write_token_here"
BLOG_API_KEY="edojo-blog-api-key-2024"
```

### 2. Ottieni il Token Sanity

1. Vai su [sanity.io/manage](https://sanity.io/manage)
2. Seleziona il tuo progetto eDojo
3. Vai su **API** → **Tokens**
4. Crea un nuovo token con permessi di **Write**
5. Copia il token nel file `.env`

## 🚀 API Endpoints

### Base URL
```
http://localhost:3000/api/blog (sviluppo)
https://yourdomain.com/api/blog (produzione)
```

### Autenticazione

Tutte le API di scrittura richiedono autenticazione tramite:

**Header X-API-Key:**
```http
X-API-Key: edojo-blog-api-key-2024
```

**O Bearer Token:**
```http
Authorization: Bearer edojo-blog-api-key-2024
```

---

## 📝 1. Pubblicazione Automatica

**Endpoint:** `POST /api/blog/publish`

L'endpoint principale per pubblicare automaticamente articoli.

### Richiesta

```http
POST /api/blog/publish
Content-Type: application/json
X-API-Key: edojo-blog-api-key-2024

{
  "title": "Il mio nuovo articolo",
  "content": "# Titolo\n\nContenuto dell'articolo...",
  "excerpt": "Breve descrizione dell'articolo",
  "categories": ["Tecnologia", "Web Development"],
  "featured": false,
  "source": "automation-script"
}
```

### Campi

| Campo | Tipo | Obbligatorio | Descrizione |
|-------|------|--------------|-------------|
| `title` | string | ✅ | Titolo dell'articolo |
| `content` | string | ✅ | Contenuto in Markdown/testo |
| `slug` | string | ❌ | URL-friendly slug (auto-generato se omesso) |
| `excerpt` | string | ❌ | Riassunto (auto-generato dai primi 150 caratteri) |
| `author` | object | ❌ | `{name: "Nome", email: "email@example.com"}` |
| `categories` | string[] | ❌ | Array di categorie |
| `featured` | boolean | ❌ | Articolo in evidenza (default: false) |
| `publishedAt` | string | ❌ | Data ISO (default: ora corrente) |
| `source` | string | ❌ | Identificatore della sorgente |

### Risposta di Successo

```json
{
  "success": true,
  "message": "Articolo pubblicato automaticamente con successo!",
  "post": {
    "id": "draft_abc123",
    "title": "Il mio nuovo articolo",
    "slug": "il-mio-nuovo-articolo",
    "publishedAt": "2024-01-15T10:30:00.000Z",
    "url": "https://yourdomain.com/blog/il-mio-nuovo-articolo",
    "createdAt": "2024-01-15T10:30:00.000Z"
  },
  "meta": {
    "source": "automation-script",
    "publishedAt": "2024-01-15T10:30:00.000Z",
    "autoGenerated": {
      "slug": true,
      "excerpt": false,
      "publishedAt": false
    }
  }
}
```

---

## 📖 2. Lettura Articoli

### Tutti gli Articoli

**Endpoint:** `GET /api/blog/posts`

```http
GET /api/blog/posts
```

### Singolo Articolo

**Endpoint:** `GET /api/blog/posts/{slug}`

```http
GET /api/blog/posts/il-mio-articolo
```

---

## ✏️ 3. Aggiornamento Articoli

**Endpoint:** `PUT /api/blog/posts/{id}`

```http
PUT /api/blog/posts/draft_abc123
Content-Type: application/json
X-API-Key: edojo-blog-api-key-2024

{
  "featured": true,
  "excerpt": "Nuovo riassunto aggiornato"
}
```

---

## 🗑️ 4. Eliminazione Articoli

**Endpoint:** `DELETE /api/blog/posts/{id}`

```http
DELETE /api/blog/posts/draft_abc123
X-API-Key: edojo-blog-api-key-2024
```

---

## 💡 Esempi di Utilizzo

### Curl

```bash
# Pubblica un articolo
curl -X POST http://localhost:3000/api/blog/publish \
  -H "Content-Type: application/json" \
  -H "X-API-Key: edojo-blog-api-key-2024" \
  -d '{
    "title": "Come configurare Next.js",
    "content": "# Setup\n\nInstalla Next.js con npm...",
    "categories": ["Tutorial", "Next.js"],
    "source": "curl-test"
  }'
```

### JavaScript/Node.js

```javascript
async function publishPost() {
  const response = await fetch('http://localhost:3000/api/blog/publish', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-API-Key': 'edojo-blog-api-key-2024'
    },
    body: JSON.stringify({
      title: 'Articolo da JavaScript',
      content: '# Contenuto\n\nQuesto è il contenuto...',
      categories: ['JavaScript', 'API'],
      source: 'javascript-automation'
    })
  });
  
  const result = await response.json();
  console.log(result);
}
```

### Python

```python
import requests

def publish_post():
    url = 'http://localhost:3000/api/blog/publish'
    headers = {
        'Content-Type': 'application/json',
        'X-API-Key': 'edojo-blog-api-key-2024'
    }
    data = {
        'title': 'Articolo da Python',
        'content': '# Contenuto\n\nQuesto è il contenuto...',
        'categories': ['Python', 'Automation'],
        'source': 'python-script'
    }
    
    response = requests.post(url, json=data, headers=headers)
    return response.json()
```

---

## 🧪 Test

### Script di Test Incluso

Esegui il test completo:

```bash
node scripts/test-blog-api.js
```

### Test Manuale

1. **Avvia il server:**
   ```bash
   npm run dev
   ```

2. **Testa l'API info:**
   ```bash
   curl -H "X-API-Key: edojo-blog-api-key-2024" \
        http://localhost:3000/api/blog/publish
   ```

3. **Pubblica un articolo di test:**
   ```bash
   curl -X POST http://localhost:3000/api/blog/publish \
     -H "Content-Type: application/json" \
     -H "X-API-Key: edojo-blog-api-key-2024" \
     -d '{"title":"Test API","content":"Contenuto di test"}'
   ```

---

## 🔒 Sicurezza

- ⚠️ **Cambia l'API key in produzione**
- 🔐 **Usa HTTPS in produzione**
- 🛡️ **Considera l'implementazione di rate limiting**
- 📝 **Monitora i log per accessi non autorizzati**

---

## 🐛 Debugging

### Log Dettagliati

Le API includono log dettagliati visibili nella console del server:

```
🚀 API: Auto-publishing blog post...
📊 Auto-publish request: { title: 'Test', hasContent: true }
👤 Getting or creating author: eDojo Team
✅ Post created successfully
```

### Errori Comuni

1. **401 Unauthorized:** Verifica l'API key
2. **400 Bad Request:** Controlla i campi obbligatori
3. **500 Internal Error:** Verifica il token Sanity

### File di Log

I log sono visibili nella console dove esegui `npm run dev`.

---

## 🔄 Integrazione CI/CD

### GitHub Actions

```yaml
name: Auto-publish blog post
on:
  push:
    paths: ['content/blog/*.md']

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Publish to blog
        run: |
          curl -X POST ${{ secrets.BLOG_API_URL }}/api/blog/publish \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.BLOG_API_KEY }}" \
            -d @content/blog/new-post.json
```

### Webhook Integration

Le API possono essere integrate con:
- **Zapier** per automazione no-code
- **GitHub Webhooks** per pubblicazione automatica
- **CMS Headless** per sincronizzazione content
- **Sistemi di monitoring** per notifiche

---

## 📊 Monitoraggio

Per monitorare l'utilizzo delle API:

1. **Check dei log del server**
2. **Monitoring della dashboard Sanity**
3. **Verifica degli articoli pubblicati su `/blog`**

---

## 🆘 Supporto

Se hai problemi:

1. Verifica la configurazione in questo documento
2. Controlla i log del server per errori dettagliati
3. Testa con lo script incluso: `node scripts/test-blog-api.js`
4. Verifica la configurazione Sanity

**Happy blogging! 🎉** 